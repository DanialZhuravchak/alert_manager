<form stylesheet="alert_manager.css" script="alert_manager.js">
  <label>Alert Manager</label>
  <fieldset autoRun="true" submitButton="true">
    <input type="time" searchWhenChanged="true" token="global_time">
      <label>Timerange:</label>
      <default>
        <earliest>-24h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="alert" searchWhenChanged="true">
      <label>Alert:</label>
      <choice value="*">All</choice>
      <seed>*</seed>
      <default>*</default>
      <search>
        <query>|inputlookup alert_state |dedup search_name |table search_name |sort search_name</query>
        <earliest>-1m</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>search_name</fieldForLabel>
      <fieldForValue>search_name</fieldForValue>
    </input>
    <input type="multiselect" token="severity" searchWhenChanged="true">
      <label>Severity:</label>
      <choice value="*">All</choice>
      <seed>*</seed>
      <default>*</default>
      <search>
        <query>|inputlookup alert_severities</query>
        <earliest>-1m</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>severity_name</fieldForLabel>
      <fieldForValue>severity</fieldForValue>
      <valueSuffix>"</valueSuffix>
      <delimiter> OR </delimiter>
      <valuePrefix>severity="</valuePrefix>
    </input>
    <input type="multiselect" token="status" searchWhenChanged="true">
      <label>Status:</label>
      <choice value="*">All</choice>
      <valuePrefix>current_state="</valuePrefix>
      <valueSuffix>"</valueSuffix>
      <delimiter> OR </delimiter>
      <search>
        <query>| inputlookup alert_status</query>
      </search>
      <fieldForLabel>status_name</fieldForLabel>
      <fieldForValue>status</fieldForValue>
      <default>*</default>
    </input>
  </fieldset>
  <search id="base_single_search">
    <query>eventtype=alert_metadata | fields job_id | lookup alert_state job_id OUTPUT severity</query>
    <earliest>$global_time.earliest$</earliest>
    <latest>$global_time.latest$</latest>
  </search>
  <row>
    <panel>
      <single id="sv_info">
        <title>Info</title>
        <search base="base_single_search">
          <query>search severity=1 | stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_low">
        <title>Low</title>
        <search base="base_single_search">
          <query>search severity=2 | stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_medium">
        <title>Medium</title>
        <search base="base_single_search">
          <query>search severity=3 | stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_high">
        <title>High</title>
        <search base="base_single_search">
          <query>search severity=4| stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_critical">
        <title>Critical</title>
        <search base="base_single_search">
          <query>search severity=5| stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <table id="alert_overview">
        <title>Recent Alerts</title>
        <search id="recent_alerts">
          <query>eventtype=alert_metadata | stats first(entry{}.content.label) as alert first(_time) as _time values(entry{}.content.eventSearch) as search values(entry{}.content.earliestTime) as earliest values(entry{}.content.latestTime) as latest first(entry{}.acl.app) as app  first(severity) AS severity by job_id | rename job_id as sid | rex mode=sed field=search "s/^search //g"  |search alert=$alert$ |  lookup alert_state job_id AS sid OUTPUT | lookup alert_severities severity OUTPUT severity_name | lookup alert_status status AS current_state OUTPUT status_name | search $severity$ $status$ |table dosearch, doedit, _time, current_assignee, status_name, sid, alert, app, severity_name, search, earliest, latest |sort -_time</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="drilldown">row</option>
        <drilldown>
          <set token="drilldown_sid">$row.sid$</set>
        </drilldown>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="alert_details" depends="$drilldown_sid$">
        <title>Alert Results</title>
        <search>
          <query>|loadjob $drilldown_sid$</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <chart>
        <title>Alerts by Severity</title>
        <search>
          <query>eventtype=alert_metadata | fields job_id | lookup alert_state job_id OUTPUT severity | lookup alert_severities severity OUTPUT severity_name | stats count by severity_name</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.fieldColors">{"Info": 0x999999, "Low": 0x5378AD, "Medium": 0x98BF3B, "High": 0xF0BE1B, "Critical": 0xFF8800, "Fatal": 0xD25B3B }</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Alerts by Status</title>
        <search>
          <query>eventtype=alert_metadata | fields job_id | lookup alert_state job_id OUTPUT current_state | lookup alert_status status AS current_state OUTPUT status_name | stats count by status_name</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.fieldColors">{"Info": 0x999999, "Low": 0x5378AD, "Medium": 0x98BF3B, "High": 0xF0BE1B, "Critical": 0xFF8800, "Fatal": 0xD25B3B }</option>
      </chart>
    </panel>
    <panel>
      <chart>
        <title>Alerts by Assignee</title>
        <search>
          <query>eventtype=alert_metadata | fields job_id | lookup alert_state job_id OUTPUT current_assignee | stats count by current_assignee</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisX.scale">linear</option>
        <option name="charting.axisY.scale">linear</option>
        <option name="charting.chart">pie</option>
        <option name="charting.chart.nullValueMode">gaps</option>
        <option name="charting.chart.sliceCollapsingThreshold">0.01</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.chart.style">shiny</option>
        <option name="charting.drilldown">all</option>
        <option name="charting.layout.splitSeries">0</option>
        <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
        <option name="charting.axisLabelsX.majorLabelStyle.rotation">0</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.axisY2.enabled">false</option>
        <option name="charting.axisY2.scale">inherit</option>
        <option name="charting.chart.bubbleMaximumSize">50</option>
        <option name="charting.chart.bubbleMinimumSize">10</option>
        <option name="charting.chart.bubbleSizeBy">area</option>
        <option name="charting.fieldColors">{"Info": 0x999999, "Low": 0x5378AD, "Medium": 0x98BF3B, "High": 0xF0BE1B, "Critical": 0xFF8800, "Fatal": 0xD25B3B }</option>
      </chart>
    </panel>
  </row>
</form>