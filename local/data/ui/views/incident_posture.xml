<form stylesheet="incident_posture.css" script="incident_posture.js">
  <label>Incident Posture</label>
  <fieldset autoRun="true" submitButton="true">
    <input type="time" searchWhenChanged="true" token="global_time">
      <label>Timerange:</label>
      <default>
        <earliest>-24h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="alert" searchWhenChanged="true">
      <label>Alert:</label>
      <choice value="*">All</choice>
      <seed>*</seed>
      <default>*</default>
      <search>
        <query>|inputlookup alert_settings |dedup search_name |table search_name |sort search_name</query>
        <earliest>-1m</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>search_name</fieldForLabel>
      <fieldForValue>search_name</fieldForValue>
    </input>
    <input type="multiselect" token="severity_id" searchWhenChanged="true">
      <label>Severity:</label>
      <choice value="*">All</choice>
      <seed>*</seed>
      <default>*</default>
      <search>
        <query>|inputlookup alert_severities</query>
        <earliest>-1m</earliest>
        <latest>now</latest>
      </search>
      <fieldForLabel>severity</fieldForLabel>
      <fieldForValue>severity_id</fieldForValue>
      <valueSuffix>"</valueSuffix>
      <delimiter> OR </delimiter>
      <valuePrefix>severity_id="</valuePrefix>
    </input>
    <input type="multiselect" token="status" searchWhenChanged="true">
      <label>Status:</label>
      <choice value="current_state=&quot;*&quot;">All</choice>
      <choice value="current_state!=&quot;resolved&quot; AND current_state!=&quot;closed&quot;">All open</choice>
      <delimiter> OR </delimiter>
      <search>
        <query>| inputlookup alert_status | eval filter_value="current_state=\""+status+"\""</query>
        <earliest>0</earliest>
      </search>
      <fieldForLabel>status_name</fieldForLabel>
      <fieldForValue>filter_value</fieldForValue>
      <default>"current_state!=""resolved"" AND current_state!=""closed"""</default>
    </input>
  </fieldset>
  <search id="base_single_search">
    <query>|inputlookup incidents |addinfo | where alert_time&gt;info_min_time AND alert_time&lt;info_max_time | search search_name=$alert$ $severity_id$ $status$</query>
    <earliest>$global_time.earliest$</earliest>
    <latest>$global_time.latest$</latest>
  </search>
  <row>
    <panel>
      <single id="sv_info">
        <title>Info</title>
        <search base="base_single_search">
          <query>search severity_id=1 | stats count</query>
        </search>
        <option name="drilldown">none</option>
        <option name="linkView">search</option>
      </single>
      <single id="sv_low">
        <title>Low</title>
        <search base="base_single_search">
          <query>search severity_id=2 | stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_medium">
        <title>Medium</title>
        <search base="base_single_search">
          <query>search severity_id=3 | stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_high">
        <title>High</title>
        <search base="base_single_search">
          <query>search severity_id=4| stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
      <single id="sv_critical">
        <title>Critical</title>
        <search base="base_single_search">
          <query>search severity_id=5| stats count</query>
        </search>
        <option name="drilldown">none</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <table id="alert_overview">
        <title>Recent Incidents</title>
        <search id="recent_alerts">
          <query>| pivot alert_manager all_alerts SPLITROW _time PERIOD auto SPLITROW label AS alert SPLITROW app SPLITROW job_id  SPLITROW event_search SPLITROW search  SPLITROW severity SPLITROW earliest SPLITROW latest ROWSUMMARY 0 COLSUMMARY 0 NUMCOLS 0 SHOWOTHER 1 | sort - _time | search alert=$alert$ |  lookup incidents job_id OUTPUT | lookup alert_status status AS current_state OUTPUT status_name |lookup alert_settings search_name as alert OUTPUT priority |lookup alert_urgencies severity, priority OUTPUT urgency  | search $severity_id$ $status$ |table dosearch, doedit, _time, current_assignee, status_name, job_id, alert, app, severity, priority, urgency, search, event_search, earliest, latest</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="drilldown">none</option>
        <drilldown>
          <set token="drilldown_job_id">$row.job_id$</set>
        </drilldown>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="count">10</option>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <table id="alert_details" depends="$drilldown_job_id$">
        <title>Alert Results</title>
        <search>
          <query>|loadjob $drilldown_job_id$</query>
          <earliest>$global_time.earliest$</earliest>
          <latest>$global_time.latest$</latest>
        </search>
        <option name="count">20</option>
        <option name="wrap">true</option>
        <option name="rowNumbers">false</option>
        <option name="dataOverlayMode">none</option>
        <option name="drilldown">cell</option>
      </table>
    </panel>
  </row>
</form>